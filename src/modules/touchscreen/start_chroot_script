#!/usr/bin/env bash
# TOUCHSCREEN for CommunityOS
# Sets up CommunityOS Touchscreen drivers
# Written by Bud Hammerton
# GPL V3
##############################

##############################
### Source error handling, leave this in place

set -e

export LC_ALL=C

source /common.sh
install_cleanup_trap

##############################
### Staging

unpack /filesystem/home/pi /home/pi pi
unpack /filesystem/root / 

##############################
### Add driver code here

if [ "$TOUCHSCREEN_INCLUDE_GENERIC" == "yes" ]; then
  pushd /home/pi
  echo "--- Installing generic drivers"
  sudo cat /home/pi/helpers/generic-config >> /boot/config.txt
  sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-generic /etc/X11/xorg.conf.d/99-calibration.conf
  if [ "$TOUCHSCREEN_GENERIC_ROTATE" == "yes" ]; then
    sudo cat /home/pi/helpers/generic-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-generic-180 /etc/X11/xorg.conf.d/99-calibration.conf
  fi
  echo "--- Generic touchscreen driver installation complete."
  popd
fi

if [ "$TOUCHSCREEN_INCLUDE_WS35" == "yes" ]; then
  pushd /home/pi
  echo "--- Installing Waveshare 3.5 LCD drivers"
  git clone $TOUCHSCREEN_WS35_ARCHIVE
  pushd /home/pi/LCD-show
  sudo cp ./waveshare35a-overlay.dtb /boot/overlays/waveshare35a.dtbo
  sudo cp ./waveshare35a-overlay.dtb /boot/overlays/
  popd
  if [ "$TOUCHSCREEN_WS35_ROTATE" != "yes" ]; then
    sudo cat /home/pi/helpers/waveshare35-config >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-35 /etc/X11/xorg.conf.d/99-calibration.conf
  else
    sudo cat /home/pi/helpers/waveshare35-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-35-180 /etc/X11/xorg.conf.d/99-calibration.conf
  fi
  echo "--- 3.5 inch touchscreen driver installation complete."
  popd
fi

if [ "$TOUCHSCREEN_INCLUDE_WS50" == "yes" ]; then
  pushd /home/pi
  echo "--- Installing Waveshare 5.0 LCD drivers"
  git clone $TOUCHSCREEN_WS50_ARCHIVE
  pushd /home/pi/LCD-show
  if [ "$TOUCHSCREEN_WS50_ROTATE" == "yes" ]; then
    echo "--- Copying rotated configuration"
    sudo cat /home/pi/helpers/waveshare5-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-5-180 /etc/X11/xorg.conf.d/99-calibration.conf
  else
    echo "--- Copying normal configuration"
    sudo cat /home/pi/helpers/waveshare5-config >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-5 /etc/X11/xorg.conf.d/99-calibration.conf
  fi
  popd
  echo "--- 5 inch touchscreen driver installation complete."
  popd
fi

##############################
### Add additional screen drivers here

if [ "$TOUCHSCREEN_INCLUDE_WS50H" == "yes" ]; then
  echo "--- Installing Waveshare 5.0 LCD (H) drivers"
  if [ "$TOUCHSCREEN_WS50H_ROTATE" == "yes" ]; then
    echo "--- Copying rotated configuration"
    sudo cat /home/pi/helpers/waveshare5h-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-5h-180 /etc/X11/xorg.conf.d/99-calibration.conf
  else
    echo "--- Copying normal configuration"
    sudo cat /home/pi/helpers/waveshare5h-config >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-5 /etc/X11/xorg.conf.d/99-calibration.conf
  fi
  echo "--- 5 inch touchscreen driver installation complete."
fi

if [ "$TOUCHSCREEN_INCLUDE_WS43" == "yes" ]; then
  echo "--- Installing Waveshare 4.3 LCD drivers"
  if [ "$TOUCHSCREEN_WS43_ROTATE" == "yes" ]; then
    echo "--- Copying rotated configuration"
    sudo cat /home/pi/helpers/waveshare43-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/40-libinput.conf-43-180 /etc/X11/xorg.conf.d/40-libinput.conf
  else
    echo "--- Copying normal configuration"
    sudo cat /home/pi/helpers/waveshare43-config >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/40-libinput.conf-43 /etc/X11/xorg.conf.d/40-libinput.conf
  fi
  echo "--- 4.3 inch touchscreen driver installation complete."
fi
	
if [ "$TOUCHSCREEN_INCLUDE_RPI7" == "yes" ]; then
  pushd /home/pi
  echo "--- Installing rPi 7 touchscreen drivers"
  sudo cat /home/pi/helpers/generic-config >> /boot/config.txt
  sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-generic /etc/X11/xorg.conf.d/99-calibration.conf
  if [ "$TOUCHSCREEN_RPI7_ROTATE" == "yes" ]; then
    sudo cat /home/pi/helpers/generic-config-180 >> /boot/config.txt
    sudo cp /etc/X11/xorg.conf.d/99-calibration.conf-generic-180 /etc/X11/xorg.conf.d/99-calibration.conf
  fi
  echo "--- rPi 7 inch touchscreen driver installation complete."
  popd
fi

##############################
### Clean up before exiting

apt-get clean
apt-get autoremove -y
set -x